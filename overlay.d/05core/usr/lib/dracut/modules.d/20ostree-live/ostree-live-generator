#!/bin/bash

set -e

UNIT_DIR="${1:-/tmp}"

add_requires() {
    local name="$1"
    local requires_dir="${UNIT_DIR}/initrd-root-fs.target.requires"
    mkdir -p "${requires_dir}"
    ln -sf "../${name}" "${requires_dir}/${name}"
}

if [ -d /run/initramfs/live -a -d /sysroot/ostree ]; then
    # Create stamp file that everything else should use to detect a live boot
    > /run/ostree-live

    add_requires sysroot.mount
    add_requires sysroot-var.mount

    # Add ostree= to the kernel command line before ostree-prepare-root
    mkdir -p "${UNIT_DIR}/ostree-prepare-root.service.d"
    cat > "${UNIT_DIR}/ostree-prepare-root.service.d/10-live.conf" <<EOF
# Automatically generated by ostree-live-generator

[Unit]
# The base unit conditions on the ostree karg, which won't exist until
# ExecStartPre runs
ConditionKernelCommandLine=
ConditionPathExists=/run/initramfs/live/LiveOS/squashfs.img

[Service]
ExecStartPre=/usr/sbin/ostree-cmdline start
ExecStartPost=/usr/sbin/ostree-cmdline stop
EOF

    # Writable area
    cat > "${UNIT_DIR}/writable.path" <<EOF
# Automatically generated by ostree-live-generator

[Unit]
Description=User data area
DefaultDependencies=false

[Path]
PathExists=/writable
EOF
    cat > "${UNIT_DIR}/writable.mount" <<EOF
# Automatically generated by ostree-live-generator

[Unit]
DefaultDependencies=false
Requires=ostree-live-populate-writable.service
Before=ostree-live-populate-writable.service

[Mount]
What=tmpfs
Where=/writable
Type=tmpfs
Options=mode=0700
EOF

    # Store /sysroot/var in the /writable tmpfs
    cat > "${UNIT_DIR}/sysroot-var.mount" <<EOF
# Automatically generated by ostree-live-generator

[Unit]
DefaultDependencies=false

# Make sure /sysroot is mounted first, since we're mounting under there
Requires=initrd-root-fs.target
After=initrd-root-fs.target

# Make sure our tmpfs is available
RequiresMountsFor=/writable

[Mount]
What=/writable/var
Where=/sysroot/var
Type=none
Options=bind
EOF
fi
